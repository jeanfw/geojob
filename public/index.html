<!DOCTYPE html>
<html>
<head>
</head>
<body>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Proche Emploi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!--
<style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
-->
    
    <script src='http://api.tiles.mapbox.com/mapbox.js/v0.6.7/mapbox.js'></script>
    <link href='http://api.tiles.mapbox.com/mapbox.js/v0.6.7/mapbox.css' rel='stylesheet' />
    <style>
      body { margin:0; padding:0; }
      #map { position:absolute; top:40px; bottom:0; width:100%; }
    </style>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/ico/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/ico/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="/img/ico/apple-touch-icon-57-precomposed.png">
                                   <link rel="shortcut icon" href="/img/ico/favicon.png">
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">Proche Emploi !</a>
          
          <form class="navbar-form pull-left" id="search_form">
            <input class="input-small" type="text" id="postal_code" name="postal_code" placeholder="code postal (ex. 75001)" value="75001">
            <input type="text" id="search_query" class="" placeholder="vendeur" value="commercial">
            <button type="submit" class="btn">Get me a job!</button>
            <span class="help-inline hidden" id="status"><img src="/img/loading.gif"><span id="status_text"></span>
          </form>
        </div>
      </div>
    </div>

    <div class="container">
      
      <ul class="thumbnails" id="search_results">
      </ul>

    </div> <!-- /container -->
    
    <div id='map'></div>
    <script>
      
      var map = mapbox.map('map');
      map.addLayer(mapbox.layer().id('jeanfw.map-5gaf13cm'));
      
      // Create an empty markers layer
      var markerLayer = mapbox.markers.layer();
    
      // Add interaction to this marker layer. This
      // binds tooltips to each marker that has title
      // and description defined.
      mapbox.markers.interaction(markerLayer);
      map.addLayer(markerLayer);
    
      map.zoom(6).center({ lat: 46.85, lon: 2.30 });
    
      // Add a single feature to the markers layer.
      // You can use .features() to add multiple features.
          
      // Attribute map
      map.ui.attribution.add()
          .content('Propulsé par <a href="http://test.data-sncf.com">SNCF Open Data</a>, <a href="http://www.zijob.fr">Zijob</a> en attendant <a href="http://www.pole-emploi.fr">P&ocirc;le Emploi Open Data</a>, et <a href="http://test.data-sncf.com">OpenStreetMaps</a> stylé par <a href="http://mapbox.com/about/maps">MapBox</a>. Un projet <a href="http://launch.datackathon.com/">Datackathon</a>, made with love Paris.');
    </script>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="http://twitter.github.com/hogan.js/builds/2.0.0/hogan-2.0.0.js"></script>

    <script src="/js/conversion.js"></script>
    <script src="/js/geojob.js"></script>
    
    <!-- API libraries should go here -->
    <script src="/js/zijob.js"></script>
    <script src="/js/sncf.js"></script>
    
    <script id="job_template" type="text/x-handlebars-template">
        <li class="span4">
          <div class="thumbnail">
            <p align="center" style="">
              <img src="{{company.logo.small}}" alt="" style="margin: auto;">
            </p>
            <h4>{{title}}</h4>
            <p>{{category.value}}</p>
            <address>
              {{location.address}}<br>
              {{location.postal_code}} {{location.city}}
            </address>
            <p>Temps de trajet: {{time}}</p>
            <p>Type de trajet: {{transport_type}}</p>
            <p>Lat/Lng: ({{lat}}, {{lng}})</p>
            <p>Lambert X/Y: ({{x}}, {{y}})</p>
            <p>
              <ul>
                {{#stations}}
                <li>{{StopPoint.StopPointName}} - {{StopPoint.Mode.ModeName}} - {{StopPoint.Mode.ModeName}} ({{Distance}}m)</li>
                {{/stations}}
              </ul>
            </p>
          </div>
        </li>
    </script>

    
    <!-- Core script -->
    
    <script type="text/javascript">
    
      // construct template string
      var template = "Hello {{world}}!";
      
      // compile template
      var job_template = Hogan.compile($("#job_template").html());

      function loadingStatus(text) {
        $('#status').removeClass('hidden');
        $('#status_text').html(text);
      }
      
      function finishedLoading() {
        $('#status').addClass('hidden');
      }
    
      $(document).ready(function() {
        $("#search_form").submit(function(e) {
          
          // Prevent form submission
          e.preventDefault();
          
          // Test geoencoding
          
          // console.log($("#postal_code").val());
          
          // loadingStatus("Nous vous localisons...");
          
          map.ease.location({ lat: 46.85, lon: 2.30 }).zoom(6).optimal();

          
          getLamb2($("#postal_code").val(), function(home_coords) {
          
            markerLayer.add_feature({
                geometry: {
                    // The order of coordinates here is lon, lat. This is because
                    // we use the GeoJSON specification for all marker features.
                    // (lon, lat is also the internal order of KML and other geographic formats)
                    coordinates: [home_coords.lng, home_coords.lat]
                },
                properties: {
                    // these properties customize the look of the marker
                    // see the simplestyle-spec for a full reference:
                    // https://github.com/mapbox/simplestyle-spec
                    'marker-color': '#fc0',
                    'marker-symbol': 'star-stroked',
                    title: "Votre domicile"
                }
            });
          
            // console.log(home_coords);
                    
            $('#home_postal_code_lambert')
            .html(home_coords.x + "; " + home_coords.y);
          
            // loadingStatus("Gares près de votre domicile...");
            
            sncfNearbyStations(home_coords.x, home_coords.y, function(err, home_stations) {
            
              // console.log(home_stations);
          
              // loadingStatus("Recherche d'offres d'emploi...");
            
              zijobKeywordSearch($("#search_query").val(), function(err, jobs) {
                if (err) console.error(err);
                else {
                
                  // loadingStatus("Cartographie des offres d'emploi...");
                  
                  $('#search_results').html('');
                  jobs.forEach(function(job) {
                  
                    getLamb2(job.location.postal_code, function(job_coords) {
                      // console.log(job_coords);
                      
                      job = $.extend(job, job_coords);
                    
                      // loadingStatus("Recherche de gares proches des offres...");
                        
                      markerLayer.add_feature({
                          geometry: {
                              // The order of coordinates here is lon, lat. This is because
                              // we use the GeoJSON specification for all marker features.
                              // (lon, lat is also the internal order of KML and other geographic formats)
                              coordinates: [job.lng, job.lat]
                          },
                          properties: {
                              // these properties customize the look of the marker
                              // see the simplestyle-spec for a full reference:
                              // https://github.com/mapbox/simplestyle-spec
                              'marker-color': '#036',
                              'marker-symbol': 'commercial',
                              title: "A " + job.time + " minutes en train"
                          }
                      });
                      
                      sncfNearbyStations(job.x, job.y, function(err, stations) {
                      
                        // console.log(stations);
                        
                        job.stations = stations;
                        
                        job.routes = [];
                        
                        // loadingStatus("Recherche croisée sur " + home_stations.length*job.stations.length + " stations...");
                        
                        for (start in home_stations) {
                          for (end in job.stations) {
                            if (home_stations[start].StopPoint && job.stations[end].StopPoint) 
                              sncfRouteList(
                                home_stations[start].StopPoint.StopArea.StopAreaExternalCode, 
                                job.stations[end].StopPoint.StopArea.StopAreaExternalCode, 
                                function(err, routes) {
                                  if (err) console.error(err);
                                  else {
                                    job.routes = job.routes.concat(routes);
                                    console.log(routes.length 
                                      + ' routes found from ' 
                                      + home_stations[start].StopPoint.StopArea.StopAreaName 
                                      + ' to ' 
                                      + job.stations[end].StopPoint.StopArea.StopAreaName)
                                  }
                                });
                            else
                              console.log("No stations for " + job.location.postal_code);
                          }
                        }
                      
                        
                        /*
$('#search_results')
                        .append(job_template.render(job));
*/
                        
                      });
                      
                    });
                    
                  })
                }
              })
            
            });
            
          });
          
        })
      });
    
    </script>
    
    <!-- /Core script -->
    
  </body>
</html>
